name: Build PHAR and attach to release

on:
  workflow_run:
    workflows: ["Update plugin version to tag"]
    types:
      - completed

permissions:
  contents: write

jobs:
  build-phar:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: phar, json, mbstring

      - name: Get tag name
        id: get_tag
        run: |
          TAG_NAME=${{ github.event.workflow_run.head_branch }}
          if [[ "$TAG_NAME" =~ ^refs/tags/ ]]; then
            TAG_NAME=${TAG_NAME#refs/tags/}
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Checkout tag
        run: |
          git fetch --tags
          git checkout ${{ env.TAG_NAME }}

      - name: Build PHAR
        run: php -dphar.readonly=0 make.php build

      - name: Get release ID
        id: get_release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ env.TAG_NAME }}';
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const release = releases.find(r => r.tag_name === tag);
            if (!release) {
              throw new Error(`Release not found for tag: ${tag}`);
            }
            core.setOutput('release_id', release.id);
            core.setOutput('upload_url', release.upload_url);

      - name: Upload PHAR to release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const pharPath = 'osticket-ai-assistant.phar';
            if (!fs.existsSync(pharPath)) {
              throw new Error(`PHAR file not found: ${pharPath}`);
            }
            const pharContent = fs.readFileSync(pharPath);
            const pharSize = fs.statSync(pharPath).size;
            console.log(`Uploading PHAR file (${pharSize} bytes)...`);
            const releaseId = '${{ steps.get_release.outputs.release_id }}';
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              name: 'osticket-ai-assistant.phar',
              data: pharContent,
              headers: {
                'content-type': 'application/octet-stream',
                'content-length': pharSize
              }
            });
            console.log('PHAR file uploaded successfully');
